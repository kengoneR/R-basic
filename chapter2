# このスクリプトで必要なパッケージ
# tidyverse, summarytools, psych, tableone

library(tidyverse) # dplyrとかggplotとかが含まれる
library(psych) # describe()で平均・標準偏差・歪度などをまとめて表示できる。あとcorr.test()で相関係数＋有意確率とか
library(tableone) # 割合、郡ごとの比較(t検定, χ^2検定など）

# データ読み込み
dataf <- 
  readr::read_csv("rent-shonandai96-04.csv")

## 下準備
# mutate: 新しい変数の作成
dataf <- 
  dataf %>% dplyr::mutate(rent_total=rent+service)
dataf <-
  dataf %>% dplyr::mutate(dist=bus+walk)

# クロス表
table(dataf$auto_lock) # オートロック付き物件が何件あるか
table(dataf$auto_lock, dataf$year)
addmargins(table(dataf$auto_lock, dataf$year)) # 列方向, 行方向の合計を追加
prop.table(table(dataf$auto_lock, dataf$year),margin=2) # 列方向に対する比率を計算

# 件数のカウント 
sum(dataf$bus==0) # 合計値を計算する関数sum()と条件式を組み合わせると「条件式を満たすサンプル数」を計算

##参考
# 行方向の比率
prop.table(table(dataf$auto_lock, dataf$year),margin=1)
# 全体の比率
prop.table(table(dataf$auto_lock, dataf$year))

# 結果表をCSVファイルに出力
prop.table(table(dataf$auto_lock, dataf$year),margin=1) %>%
  print() %>%
  write.csv("result.csv")

#######################
# 連続変数のカテゴリー化
#######################
# 賃貸料3万円刻みで5つの階級から構成されるカテゴリー変数を作成
dataf <-
  dataf %>% 
  mutate(r_category=case_when(
    rent_total>=3&rent_total<6 ~"03-06",
    rent_total>=6&rent_total<9 ~"06-09",
    rent_total>=9&rent_total<12 ~"09-12",
    rent_total>=12&rent_total<15~"12-15",
    rent_total>=15&rent_total<18~"15-18",
    rent_total>=18~"18-"))

table(dataf$r_category) # table()関数で r_categoryの件数を表にする(度数分布表）

#ヒストグラムの作成
barplot(table(dataf$r_category)) # 表から棒グラフを作成

# 1996と2004年のデータに限定してヒストグラムを作成
dataf96 <-
  dataf %>% dplyr::filter(year==1996)
barplot(table(dataf96$r_category))

dataf04 <-
  dataf %>% dplyr::filter(year==2004)
barplot(table(dataf04$r_category))

# 記述統計
summary(dataf$rent_total) # rent_totalの統計量(最小値, 第一四分位, 中位数, 平均値, 第三四分位, 最大値)を出力
summary(dataf)
# describeはpsychパッケージのインストール&呼び出しが必要
psych::describe(dataf) # pshch::describe()関数は、標本数(n)や平均(mean),標準偏差(sd),最大(max),最小(min)などの統計量を出力する
psych::describe(dataf,skew=FALSE)　# skew=FALSEを付けない場合、尖度や歪度など計12種類の統計量が出力される

# CSVファイルに出力
psych::describe(dataf,skew=FALSE) %>% 
  write.csv("result.csv")

# グループ別の平均値
dataf %>% 
  dplyr::group_by(year) %>%
  summarise(mean(rent_total),sd(rent_total)) # summarize(関数名(計算の対象となる変数名))

# 年別オートロックの有無別の平均値
dataf %>% 
  dplyr::group_by(year, auto_lock) %>% 
  summarise(mean(rent_total))

# tidyr::pivot_widerを使うと見栄えがよくなる（表頭項目と表示させる値を指定できる）
dataf %>% 
  dplyr::group_by(year, auto_lock) %>% 
  summarise(m_rent=mean(rent_total)) %>%
  tidyr::pivot_wider(names_from=auto_lock, values_from=m_rent) 
# tidyr::pivot_wider(names_from=列方向の変数, values_from=値)

#平均値の差の検定
#1994と2004の平均値は統計的に有意な差があるか
  tableone::CreateTableOne(vars=c("rent_total","floor","age","auto_lock"),strata="year",factorVars="auto_lock",data=dataf)
  tableone::CreateTableOne(vars="rent_total",strata="auto_lock",data=dataf)
# tableone::CreateTableOne(vars="変数名",strata="グループ化する変数名",factorVars="変数名",data=dataf)

# ggplotによる散布図
# ggplot(data=データフレーム名, aes(x=横軸の変数, y=縦軸の変数))+
  geom_point()
ggplot(data=dataf, aes(x=age, y=rent_total))+
  geom_point()
ggplot(data=dataf, aes(x=floor, y=rent_total))+
  geom_point()

# 図をpngファイルに出力
# png(filename = "ファイル名",width=幅を指定,height=高さを指定)
png(filename = "scatter.png",width=400,height=300)
ggplot(data=dataf, aes(x=floor, y=rent_total))+
  geom_point()
dev.off() # 描画先を閉じる

# 相関係数
# cor(データフレーム$変数1,データフレーム$変数2,use="pairwise.complete.obs")
cor(dataf$rent_total,dataf$floor,use="pairwise.complete.obs")
# 変数を限定して相関係数行列を作成
dataf_cor <-
  dataf %>% dplyr::select(rent_total, dist, age, floor)
cor(dataf_cor,use="pairwise.complete.obs")
