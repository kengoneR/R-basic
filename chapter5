# 差の差の分析とパネル・データ分析
# 前後比較と差の差の分析
# 差の差の分析による政策効果の分析

# treatダミー作成
dataf <- dataf %>% dplyr::mutate(treat=if_else(station=="shonandai",1.0))
# treat*2004年ダミー作成
dataf <- dataf %>% dplyr::mutate(treat2004=if_else((station=="shonandai"&year==2004),1,0))
# 2004年ダミー作成
Dataf <- dataf %>% dplyr::mutate(year2004=if_else(year==2004,1,0))
# 前後比較分析（湘南台限定）
result1 <- estimatr::lm_robust(rent_total~floor+age+dist+treat2004,data=dataf, station=="shonadai")
summary(result1)
# 差の差の分析
result2 <- estimatr::lm_robust(rent_total~floor+age+dist+treat+year2004+treat2004,data=dataf)
summary(result2)

# パネル・データ分析による差の差の分析
# パネル・データとは何か
# パネル・データ利用のメリット：何がわかるのか？
# プーリング回帰モデル
# 固定効果モデル(Fixed Effect Model)
# 時点固定効果

# Rによる固定効果モデルの推定
estimatr::lm_robust(formula = emprate ~ caprate, data = dataf)

estimatr::lm_robust(emprate ~ caprate+factor(year), data = dataf)
# この結果は以下3行と同じになる
data <- dataf %>% dplyr::mutate(y2005=if_else(year==2005,1,0))
data <- dataf %>% dplyr::mutate(y2010=if_else(year==2010,1,0))
estimatr::lm_robust(emprate~caprate+y2005+y2010, data=dataf)
# 時点固定効果
estimatr::lm_robust(formula = emprate ~ caprate + factor(year), data = dataf)
# 時点&個体固定効果
estimatr::lm_robust(formula = emprate ~ caprate + factor(year) + factor(pref), data =dataf)

# lm_robust()関数に個体固定効果と年次固定効果を入れるもう1つの書き方（fixed_effectsオプションを使う）
estimatr::lm_robust(formula = emprate ~ caprate, fixed_effects=~pref+year, data = dataf)

#パネル・データ分析の時はfixestパッケージが便利（固定効果モデルの推定はfeols()関数）
# fixest::feols(Y~X1+X2+X3|固定効果, data=オブジェクト)
fixest::feols(emprate~caprate|pref+year, data=dataf)
# 以下のように"|固定効果"　を省略すると最小二乗法の結果が出力される
fixest::feols(Y~X1+X2+X3, data= データフレーム)

# 結果の出力方法
# fixestにはetable()という関数が用意されており、推定結果を整理して表として出力することが出来る
# 結果オブジェクト1 <- fixest::feols(Y~X1+X2, data=データフレーム名)
# 結果オブジェクト2 <- fixest::feols(Y~X1+X2| 個体固定効果, data=データフレーム名)
# 結果オブジェクト3 <- fixest::feols(Y~X1+X2| 個体固定効果＋時間固定効果, data=データフレーム名)
# fixest::etable(結果オブジェクト1, 結果オブジェクト2, 結果オブジェクト3, 
signif.code=c("***"=0.01,"**"=0.05, "*"=0.1), se.below=TRUE)
# signif.codeはｐ値に応じて星をつけるオプション
